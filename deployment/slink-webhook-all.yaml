apiVersion: v1
kind: Namespace
metadata:
  name: slink-webhook
---
apiVersion: v1
kind: Service
metadata:
  namespace: slink-webhook
  name: slink-webhook
spec:
  selector:
    app: slink-webhook
  ports:
  - port: 443
    name: https
    targetPort: 8443
---
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: slink-webhook
  name: slink-webhook
spec:
  selector:
    matchLabels:
      app: slink-webhook
  template:
    metadata:
      labels:
        app: slink-webhook
    spec:
      enableServiceLinks: false
      containers:
      - name: slink-webhook
        image: docker.io/uablrek/slink-webhook:latest
        imagePullPolicy: IfNotPresent
        env:
        - name: LOG_LEVEL
          value: "0"
        - name: CRT_FILE
          value: "/cert/slink-webhook.crt"
        - name: KEY_FILE
          value: "/cert/slink-webhook.key"
        ports:
          - containerPort: 8443
            name: https
        livenessProbe:
          httpGet:
            path: /health
            port: https
            scheme: HTTPS
          failureThreshold: 1
          periodSeconds: 30
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  name: slink-webhook
  labels:
    app: slink-webhook
webhooks:
  - name: slink-webhook.default.svc
    admissionReviewVersions: ["v1"]
    clientConfig:
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUQ0VENDQXNtZ0F3SUJBZ0lVWUhOMEFaUW9VTmhSeDdiZkJkdWNVTUZLTE00d0RRWUpLb1pJaHZjTkFRRUwKQlFBd0tqRW9NQ1lHQTFVRUF3d2ZjMnhwYm1zdGQyVmlhRzl2YXk1emJHbHVheTEzWldKb2IyOXJMbk4yWXpBZQpGdzB5TXpFeU1qWXhOVE14TkRkYUZ3MHpNekV5TWpNeE5UTXhORGRhTUNveEtEQW1CZ05WQkFNTUgzTnNhVzVyCkxYZGxZbWh2YjJzdWMyeHBibXN0ZDJWaWFHOXZheTV6ZG1Nd2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUIKRHdBd2dnRUtBb0lCQVFDODVzSHVzczBPeFc3U0FudkFJREdLZklqSWx6RjFmVUMvSWRRZzFaMWpZejRqYTVaRQpGYUxWS1N5OEdGUzZ5TklXeHBXTXRUTzVYY1VSSWN5WlE4ZEY0TEozNU5NZ1YySStEOU9uUG1tYmcyVEVuRU10CmJSamwwTHF3TzM0N243MFFubzB4TzdUYmRLYndBczZBTC9XUjFmTDBNVkJqdzZFeE9pMDRPcUxudkMyQ3JubzgKVmV4WDJXZHJwODNxZzkyNHpYait0Vks2d3Y0dU5rT2FHYzhBaHovWThvZVdqbWRZZW9QdXlicDdlYktyUlRDSgovTlRzKzlKQUdpRUdBbVZKclQyWnFYTEc0ZHpSOVUvNWpiSStXWVVIT0ZLbVlqQUtudEFSL3ZMMWpZWVM0REpNCnZ0ZncyRjB3OXRoTDVFNmhTWDliTk83ZWN1Z25RanNPblFnTEFnTUJBQUdqZ2Y0d2dmc3dDd1lEVlIwUEJBUUQKQWdYZ01CTUdBMVVkSlFRTU1Bb0dDQ3NHQVFVRkJ3TUJNSUdGQmdOVkhSRUVmakI4Z2cxemJHbHVheTEzWldKbwpiMjlyZ2h0emJHbHVheTEzWldKb2IyOXJMbk5zYVc1ckxYZGxZbWh2YjJ1Q0gzTnNhVzVyTFhkbFltaHZiMnN1CmMyeHBibXN0ZDJWaWFHOXZheTV6ZG1PQ0xYTnNhVzVyTFhkbFltaHZiMnN1YzJ4cGJtc3RkMlZpYUc5dmF5NXoKZG1NdVkyeDFjM1JsY2k1c2IyTmhiREFkQmdOVkhRNEVGZ1FVRkwrSzdJVmVyQkVtRHRWYmtJcndDSGNyb0VVdwpId1lEVlIwakJCZ3dGb0FVRkwrSzdJVmVyQkVtRHRWYmtJcndDSGNyb0VVd0R3WURWUjBUQVFIL0JBVXdBd0VCCi96QU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFKNEFOMFRlRElRUUhlTWlqRmFrUm9uSGc3YzJKeXdpUWxkTWMKdWFncVVtZWVVRlNDcjEwek12c09NczY2RnBCZVJGbm5EWXBLUHNBOUVleWxNMEN3R2xtUGlBYThLSnJ4UUxIeAppL0xmeGVmQ0UwUDhKN1NReFVSeVVsRUN1eXZJYy9OQTBGNlMvdDdoczVJTXJESnFxaWw1VEc5bG5CY0orWGtDCkVJdVM0NE92UDNZL1RpNS9iVitkOW5nZFlEcitpKytBWWFmWTJ4ZzdOdFVJcGhSZzRweGpOOUJFb2s4QWg5eHYKN0tHNFNzck8ydEUzWm8yM056Y2JXSVdNRTUwM2t6K05XYldOT1hsYVhPZUNuT0Z4RTB1V005ZjBBcXNWWmZzWAoxOHdVUDkrTGdKWFIrTWlQeS9hWG1NZ0JjbU1ReHYwdkpFRFBMbE9pMkVVWit6eEtjdz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
      service:
        name: slink-webhook
        namespace: slink-webhook
        path: "/"
        port: 443
    rules:
      - operations: ["CREATE", "UPDATE"]
        apiGroups: [""]
        apiVersions: ["v1"]
        resources: ["pods"]
    sideEffects: None
    timeoutSeconds: 5
    reinvocationPolicy: Never
    failurePolicy: Ignore
    namespaceSelector:
      matchExpressions:
        - key: kubernetes.io/metadata.name
          operator: NotIn
          values: ["kube-system", "slink-webhook"]
